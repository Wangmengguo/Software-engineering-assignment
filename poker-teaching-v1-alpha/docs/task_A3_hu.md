# 任务单 · A3（首批 8 标签 + HandMetric 持久化）

> 目标：以“标签驱动训练”为核心，按 TDD 将首批 8 个高价值标签接入建议流程，并将逐手标签与关键切片写入 HandMetric，保持契约与 A1 一致、与 A2 不冲突。严格先红后绿，阶段完成前不越级推进。

---

## 结论（TL;DR）

- 方向正确：A3 仅做“基础/数学”两类轻标签，服务回放筛选与教学提示，冷启动少即是多；
- 再拆成 9 个子任务：字典与口径→触发规则→优先级与去重→打标管线→存储契约→回放筛选口径→观测指标→质量门与快照→文案与 i18n；
- 明确三大模糊点与两处耦合风险的裁决与切断；
- 最小验收与停表信号量化，确保稳定上线、不引入复杂度。

---

## 0. 范围与非目标

- 范围（A3 仅做）：
  - 首批 8 标签（基础×4、数学×4）的判定与返回：
    - 基础：`BTN_RFI_LOW`, `BB_DEFEND_LOW`, `C_BET_DRY_LOW`, `XR_OVER_LOW`
    - 数学：`MDF_UNDERDEFEND`, `POT_ODDS_MISS`, `FE_OVERESTIMATE`, `COMMIT_MISS_LOW_SPR`
  - 在 Suggest 响应中填充 `train_tags`（与 A1 契约一致，字段可选，默认空→有值）；
  - 新增 `HandMetric` 表，逐手写入最小切片（位置/SPR/牌面类/数学量摘要/结果/标签）；
  - 基于旗标灰度：`FEATURE_TRAIN_TAGS_V1` 控制标签注入与落库。
- 非目标（本阶段不做）：
  - KPI 聚合、仪表、标签主题排序（A4/A5 再做）；
  - 对手画像或剥削相关标签（C 阶段）；
  - 训练卡包/任务流（后续）。

---

## 1. 用户故事（简）

- 作为学习者：我能在每手建议中看到少量、明确的“可改善点”标签，回放页可按标签筛手。
- 作为产品/运营：标签枚举稳定、文案一致、误报率可控；可灰度上线，并可回滚。

---

## 2. 词典与口径（Contract-First）

- 标签枚举与含义（键稳定，文案走 i18n）：
  - `BTN_RFI_LOW`：按钮开局低于目标带（80–90%）。
  - `BB_DEFEND_LOW`：大盲对 2.0–2.5x 防守不足（目标 60–70%）。
  - `C_BET_DRY_LOW`：SRP 干燥高牌面 C-bet 低于 70–80%。
  - `XR_OVER_LOW`：SRP OOP 的 flop check-raise 低于 10–14%。
  - `MDF_UNDERDEFEND`：面对下注，低于 MDF 防守底线。
  - `POT_ODDS_MISS`：应以赔率盈利而选择了弃牌。
  - `FE_OVERESTIMATE`：下注需要的弃牌率高于合理范围。
  - `COMMIT_MISS_LOW_SPR`：低 SPR（≤3）应承诺而未承诺。
- 字段对齐：
  - Suggest 响应 `train_tags: string[]`（A1 已定义，可选）；
  - HandMetric 最小字段建议：`hand_id, pos, eff_bb, board_class, spr_bin, math:{need_equity, mdf_needed, fe_req, is_compliant}, tags[], result{net_bb,showdown}`。

---

## 3. 可执行任务清单（严格顺序，TDD）

- T1 标签判定单测（红）：`tests/test_labels_basic.py`
  - 为 8 个标签各给 1–2 条最小触发/不触发样例，断言纯函数 `infer_tags(hand_slice)` 输出稳定键集合。
- T2 HandMetric 契约测试（红）：`tests/test_handmetric_contract.py`
  - 断言模型字段/默认值/约束存在；创建一条示例记录并校验 JSON 结构；
  - 若使用 Django ORM，则用 `django_db` 标记并校验迁移可运行。
- T3 API 注入测试（红）：`tests/test_api_train_tags_field.py`
  - 调用 `/api/v1/suggest`，断言 `train_tags` 字段存在（可为空数组）；开启 `FEATURE_TRAIN_TAGS_V1=on` 后，至少出现 0–3 个标签；
  - 背靠 1–2 个可控场景（如干燥 SRP）断言包含 `C_BET_DRY_LOW` 等标签。
- T4 回放筛选测试（红）：`tests/test_replay_filter_by_tag.py`
  - 走过一小段对局，落库 3–5 手 HandMetric；
  - 调用回放筛选接口/视图，断言能按标签过滤得到手牌列表（仅最小可用）。
- I1 标签引擎最小实现（绿）：
  - 新建 `packages/poker_core/suggest/labels.py`（纯函数），只依赖当手切片与 A2/A1 的数学助手/分类助手；
  - 不引入对手画像；保持键稳定；支持空安全。
- I2 HandMetric 模型与写入（绿）：
  - 新增模型（或表结构），在建议流程中（或回放落点）写入 HandMetric；
  - 加开关 `FEATURE_TRAIN_TAGS_V1`；失败不影响建议返回（降级）。
- I3 API 注入与回放筛选（绿）：
  - 在建议响应中注入 `train_tags`；
  - 回放页或 API 支持按标签筛选列表（最小可用）。
- R1 回归与快照：
  - 为 2–3 套标准样例响应保存 JSON 快照；
  - 验证旧测试不回归、延迟目标不变。

说明：任一测试未绿，禁止推进到下一步；严格“先红→后绿→必要重构”。

---

## 3.1 子任务九项（Do，不增复杂度）

- A3-1｜标签字典与口径：≤10 个键，含中文短名/一句解释（≤20字）/触发口径/级别（H/M/L）/示例；阈值以“可读区间”呈现。
- A3-2｜触发规则：用自然语言列出逐手触发式样；窗口不足仅打“方向性标签”。
- A3-3｜优先级与去重：数学优先于基础；同类只留最重（H>M>L）；单手上限≤3。
- A3-4｜打标管线：计算器→规则器→整形器的分工，函数式、可重放。
- A3-5｜存储契约：`HandMetric.tags` 仅存英文键数组；另存本手节点摘要以便筛选。
- A3-6｜回放筛选口径：默认展示 Top-3 标签主题（排序留到 A4/A5），A3 只做筛选与列表。
- A3-7｜观测指标：`tag_generated_total`、`tag_by_key_total{key}`、`tag_per_hand_histogram`、`tag_dropped_due_to_limit_total`。
- A3-8｜质量门与快照：字典 linter + 10 手标准牌标签快照；合并入 CI。
- A3-9｜文案与 i18n：引擎只产键；UI 模板把键→人话（区间/理由/动作/标签名；≤120字；中英对齐）。

---

## 4. 实施要点（不落实现细节）

- 判定原则：
  - 基础标签依赖区间与简单计数；数学标签依赖 A2 的 `mdf_needed/need_equity/fe_req`；
  - 标签触发门槛使用“教学目标带 ±5pt”，不足样本仅给方向性标签；
  - 同类轻微偏差合并，单手不超过 3 个标签。
- 灰度与降级：
  - `FEATURE_TRAIN_TAGS_V1` 控制注入与落库；
  - 落库失败不阻断建议（写失败计数 + 降级日志）。
- 兼容与文案：
  - 键稳定，文案由 i18n/模板生成；
  - 响应中 `train_tags` 可为空数组，不返回 null。

---

## 5. 非功能与守护线

- 性能：判定为 O(1) 纯函数；落库为可选路径；建议 API P95 仍 ≤150ms。
- 数据最小化：仅存训练必要字段；不含个人敏感信息；支持删除与留存周期配置。
- 一致性：同状态同输入的标签集合稳定；标注“方向性”不给数值化 EV。
- 观测：
  - 轻量计数：`train_tags_emitted_total`, `handmetric_write_total`, `handmetric_write_failed_total`；
  - 可后续接入 Prometheus（A7）。

---

## 6. 验收标准（A3）

- T1–T4 新增测试全部通过；旧测试不回归；
- 在典型路径中，≥70% 的手牌至少有 1 个基础/数学标签；
- HandMetric 表成功写入示例数据，回放可按标签筛选；
- 性能与降级口径达标，灰度可控、可回滚。

---

## 7. 风险与回退

- 误报率高 → 收紧阈值/减少触发位，保持“少而准”；
- 延迟上升 → 将落库改为异步/降级为内存队列（不在本阶段强制）；
- 数据口径不一 → 以 A1/A2 词典与小字典为准，禁止私有口径；
- 回退：关闭 `FEATURE_TRAIN_TAGS_V1`，保留 A1 的空数组占位。

---

## 8. 模糊点（Clarify）

- 阈值归属：A3 仅用全局教学基线（指标蓝图），节点/牌面细分放 A2/B 后续；
- 窗口与样本门槛：近期=1k，最小样本≥300 手；不足仅打“方向性标签”；
- 数学数据依赖：首期只看“当前节点的数学正确性”（如 need≤est 却弃牌→触发），跨手趋势交给 KPI。

---

## 9. 过度耦合风险（Decouple）

- 标签↔KPI 聚合：写入标签与 KPI 聚合解耦，失败互不拖累；
- 标签↔文案：引擎产键；UI/i18n 产文案；字典版本化；
- 标签↔对手画像：A3 禁止读取画像，剥削相关标签留到 B/C；
- 标签↔回放深交互：A3 只做筛选与列表，主题复盘放 B。

---

## 10. 最小验收与停表信号（Acceptance & Guardrails）

- 上线条件：
  - 单手 0–3 标签，平均≤2；首批标签覆盖≥70%“可打标场景”；10 手标准牌标签快照稳定；
  - 观测可见标签分布（Top-5 键）与“被限流”次数；回放可按标签筛选并默认显示 Top-3 主题列表。
- 红灯停表：
  - 单手平均标签数>3 且持续上升；`tag_dropped_due_to_limit_total` 激增；
  - 标签与 R/W/D 建议出现高频矛盾投诉（教学冲突）。
- 黄灯观察：
  - 单一标签触发占比>40%；大量“方向性标签”长期不转“强标签”。
