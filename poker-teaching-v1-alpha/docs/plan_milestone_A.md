# 里程碑A · 可落地技术实现计划（R/W/D 最小集 + Turn/River 基线 + 标签 + KPI 最小集）

> 目标：在不引入技术爆炸的前提下，稳定上线 R/W/D 四块建议输出、Turn/River 基线最小集、逐手基础/数学标签与最小集 KPI 仪表；P95 建议延迟≤50ms（引擎内）。

---

## 0. 范围与非目标

- 范围：
  - 建议页固定输出 R/W/D（Range/Why/Do/Train 标签）；
  - Turn/River 基线最小集（尺寸桶 + 常见 facing 分支 + MDF/需要权益提示）；
  - 逐手生成“基础/数学”标签（首批 8–10 个，见 §2.1）；
  - KPI 最小集（WWSF/WTSD/W$SD、Fold to Flop C-bet、A 高干燥面 C-bet），近期=1k、长期=10k，样本不足显示“方向性”。
- 非目标（本里程碑不做）：
  - 对手画像与剥削偏移（推迟至里程碑C）；
  - 训练卡包/任务流；
  - 数值化 EV 反事实；
  - 策略 DSL/可视化编辑器。

---

## 1. 架构与技术约束（栈/存储/安全/设计系统/运维）

- 栈与边界
  - 引擎：Python 3.11，`packages/poker_core/suggest/*` 纯函数 + JSON 配置；
  - Web/API：Django + DRF（`apps/web-django/api`），保持后端渲染模板；
  - 配置：继续 JSON（策略档位/范围/规则），配置缓存与质量门沿用；
  - 国际化：中英双语并存，术语表统一。
- 数据存储
  - 开发：SQLite；生产：预留 PostgreSQL 切换位；
  - 新增表：`HandMetric`（一手一行）存储关键切片：
    - 关键字段：`hand_id, pos, eff_bb, preflop/flop/turn/river/math JSON, result JSON, tags (ARRAY/JSON)`；
    - 指标聚合走轻量 SQL/ORM 视图，暂不引入离线任务。
- 安全与合规
  - 数据最小化：不采集个人敏感信息；`hand_id/session_id` 随机化；
  - 日志脱敏：不落明手牌文本，异常栈定级采样；
  - 留存：开发默认 7–30 天，生产可配置；删除流程与权限控制明确。
- 设计系统与体验
  - R/W/D 四句式模板（见 §2.4），红/黄/绿灯配文字；色弱友好；
  - 不引入重前端框架；使用 CSS 变量定义语义色与间距；
  - 反事实仅给“方向性趋势”，尾缀统一提示（见 §2.3）。
- 可观测性与运维
  - 指标：建议延迟直方图、错误计数、R/W/D 生成计数、标签生成计数；
  - 灰度与回滚开关（见 §2.6），Prometheus `/metrics` 已暴露；
  - “停一停”阈值：红灯/黄灯（见 §2.6）。

---

## 2. 补强点（Do 具体怎么做）

### 2.1 标签字典收敛（首批 8–10 个）

- 原则：只上“抓得住收益”的标签，降低误报与学习负担。
- 首批标签（示例，8 个）：
  - 基础（4）：`BTN_RFI_LOW`, `BB_DEFEND_LOW`, `C_BET_DRY_LOW`, `XR_OVER_LOW`；
  - 数学（4）：`MDF_UNDERDEFEND`, `POT_ODDS_MISS`, `FE_OVERESTIMATE`, `COMMIT_MISS_LOW_SPR`。
- 实施：
  - 新增 `packages/poker_core/suggest/labels.py`（纯函数）：输入单手牌切片 → 输出上述标签子集；
  - `service.py` 组装建议后调用打标；
  - 回放页默认聚合 Top-3 标签主题与代表手，点击即看“区间/理由/动作”。

### 2.2 KPI 最小集的口径统一

- 口径与样本门槛：近期=1k、长期=10k，不足显示“方向性”。
- 目标区间：WWSF 47–52%；WTSD 32–37%；W$SD 49–54%；Fold to Flop C-bet 40–50%；A 高干燥面 C-bet 70–80%。
- 实施：
  - 在仪表旁直写区间与样本状态；
  - 触发联动：任一项偏离±5pt → 对应标签主题置顶（如 WWSF 低 → 推 `C_BET_DRY_LOW`）。

### 2.3 反事实提示的“方向性边界”

- 规则：仅给趋势，不给数值 EV；统一尾缀：“本提示为方向性教学建议”。
- 实施：R/W/D 的 Do 卡片内增加 `nudge` 文案位，模板化输出趋势+尾缀。

### 2.4 R/W/D 文案模板固定

- 四句式：
  1) 区间：你现在… / 目标…；
  2) 理由：基于…（位置/牌面/SPR/数学量）；
  3) 动作：下次优先…（动作/尺寸/调整）；
  4) 标签：已加入回放筛选。
- 实施：
  - 文档新增 6 个常见场景模板（干燥面 IP、湿面 OOP、低 SPR 承诺、河牌配比…）；
  - 解释模板落位于 `packages/poker_core/suggest/explanations.py` 的自然语言层。

### 2.5 兜底与一致性

- 规则：未命中规则时必须给安全兜底与降级文案（如“此牌面接近均衡，优先控池/小注试探”）。
- 实施：
  - 在 `policy.py/turn_river_rules.py` 增设 `fallback_plan` 分支；
  - `decision.py` 继续最小金额钳制；
  - 输出 rationale 码 `W_FALLBACK_USED` 便于观测。

### 2.6 灰度与回滚的触发信号

- 红灯（立即停止灰度/回滚）：
  - P95 延迟 > 80ms 连续 30 分钟；错误率 >1%；R/W/D 漏字段 >0.5%。
- 黄灯（暂停扩容、观察）：
  - 核心 KPI 任一项较基线劣化 >3pt 且持续 24h。
- 实施：
  - Prometheus 增加相应计数与直方图；
  - 变更单模板包含“灰度目标与停表阈值”。

---

## 3. 技术交付物与接口变更

- Suggest API（`apps/web-django/api/views_suggest.py`）新增可选字段（兼容旧客户端）：
  - `range`: { node, bucket, size_options, target_freq_band }
  - `why`: [{ code, msg, data }]（含数学量摘要 need_equity/MDF/FE）
  - `do`: { action, amount/size_tag, nudge }
  - `train_tags`: [string]
- 数据模型：新增 `HandMetric`（`apps/web-django/api/models.py`）记录逐手切片与标签。
- 指标：补充 R/W/D 生成计数、标签生成计数、打标失败计数；现有建议延迟直方图沿用。

---

## 4. Turn/River 基线最小集（不求全，保证主干）

- 尺寸桶：`0.25–0.33P / 0.5–0.66P / 0.75–1.0P / 1.5–2.0P`。
- Turn：
  - SRP/3BP，IP/OOP 的 second barrel 主干；
  - 面对 0.5P/1.0P 的 MDF 合规防守（提示为主），少量 value-raise 触发位；
  - 延迟 C-bet 基础线（方向性）。
- River：
  - 依据尺寸桶给出价值:诈唬配比“基线提示”（不输出数值 EV）；
  - 强制输出“方向性提示”尾缀；
  - 统一 fallback 文案。

---

## 5. 工作分解与时间线（2–4 周）

- 第1周
  - A1：API 契约扩展（R/W/D 字段、nudge 尾缀）；
  - A2：Turn 主干规则与 fallback；
  - A3：`labels.py` 首批 8 标签；模型迁移 `HandMetric`；
  - A4：仪表口径与 UI 占位（区间 + 样本状态）。
- 第2周
  - A5：River 主干与方向性提示；
  - A6：回放筛选与 Top-3 标签主题聚合；
  - A7：Prometheus 补强与红/黄灯阈值可观测；
  - A8：文档补充 6 个场景模板。
- 第3周
  - A9：单测/快照完善；建议合规率统计（以 `need≤est` 为分母）；
  - A10：性能与兜底回归；小流量灰度；
  - A11：验收自检与变更清单。
- 第4周（缓冲）
  - 修缮、文案与国际化打磨，准备切到里程碑B。

---

## 6. 验收标准（强化版）

- 建议合规率≥80%（以“need≤est”的场景为分母统计）。
- Turn/River 主干命中率≥95%（典型路径），其余走兜底且有降级文案。
- 标签覆盖：≥70% 的手牌至少命中 1 个基础/数学标签；回放默认聚合 Top-3 主题。
- KPI 展示：近期/长期双刻度；样本不足出现“方向性”文案；超出±5pt 可联动置顶标签主题。
- 一致性：同状态 R/W/D 输出一致；反事实仅给趋势，统一尾缀提示。
- 性能与稳定：P95 引擎≤50ms，API≤150ms；错误率受控；红/黄灯阈值可观测。

---

## 7. 风险与缓解

- 数据样本不足 → 显示“方向性”并延迟强结论；
- Turn/River 覆盖不全 → 尺寸桶 + MDF 提示 + fallback；
- 文案过技术 → 四句式模板 + 术语表；
- 指标噪声 → 近期/长期双刻度 + Top-3 主题聚合；
- 回滚需要 → 配置与标签字典版本化，灰度开关与快照对比。

---

## 8. 真实限制覆盖检查（对应 §2 六点）

- 标签收敛：首批 8 个标签，降低误报；实现于 `labels.py`，回放 Top-3 聚合。
- KPI 口径：在仪表旁写死区间与样本状态；±5pt 触发主题置顶。
- 反事实边界：仅趋势 + 统一尾缀；不输出数值 EV。
- R/W/D 模板：四句式固定，6 个场景模板文档化并复用。
- 兜底一致性：`fallback_plan` + `W_FALLBACK_USED` 观测；金额钳制定义为产品约束。
- 灰度/回滚信号：红/黄灯阈值与 Prometheus 指标落地；变更单包含“停表阈值”。

