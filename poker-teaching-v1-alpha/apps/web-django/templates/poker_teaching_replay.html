<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Poker Teaching — Hand Replay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config={theme:{extend:{boxShadow:{elevated:"0 4px 16px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.04)"}}}};</script>
    <style>
      :root{--bg:248 249 251;--surface:255 255 255;--text:17 24 39;--muted:113 113 122;--border:228 228 231;--ring:226 232 240;--brand-600:79 70 229;--action:var(--brand-600);--info:59 130 246}
      [data-theme="dark"]{--bg:17 17 19;--surface:24 24 27;--text:244 244 245;--muted:161 161 170;--border:63 63 70;--ring:63 63 70;--brand-600:99 102 241;--action:var(--brand-600);--info:96 165 250}
    </style>
    <style type="text/tailwindcss">
      @layer components{
        .card{@apply bg-[rgb(var(--surface))] border border-[rgb(var(--border))] rounded-2xl shadow-sm}
        .btn{@apply inline-flex items-center justify-center gap-2 rounded-xl h-11 px-4 font-medium transition active:scale-[.98] select-none disabled:opacity-50 disabled:cursor-not-allowed}
        .btn-primary{@apply text-white shadow; background-color:rgb(var(--action))}
        .btn-primary:hover{filter:brightness(.95)}
        .btn-ghost{@apply border border-[rgb(var(--border))] bg-transparent text-[rgb(var(--text))]}
        .stat-label{@apply text-xs uppercase tracking-wide text-[rgb(var(--muted))]}
        .stat-value{@apply text-sm font-semibold text-[rgb(var(--text))]}
        .chip{@apply text-xs font-semibold px-2.5 py-1 rounded-full border border-[rgb(var(--border))] bg-[rgb(var(--surface))]}
        .divider{@apply h-px bg-[rgb(var(--border))]}
      }
      .row-current{background:rgba(99,102,241,.08)}
      .card-red{color:#dc2626}
      .card-black{color:rgb(var(--text))}
    </style>

    <!-- Theme toggle styles -->
    <link rel="stylesheet" href="/static/css/theme-toggle.css">
  </head>
  <body class="min-h-screen bg-[rgb(var(--bg))] text-[rgb(var(--text))] antialiased">
    <div class="mx-auto px-4 lg:px-6 grid gap-6 min-h-screen" style="max-width: 900px;">
      <header class="sticky top-0 z-40 -mx-4 lg:-mx-6 px-4 lg:px-6 py-3 bg-[rgb(var(--bg))]/80 backdrop-blur border-b border-[rgb(var(--border))]">
        <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
          <div class="flex items-center gap-4">
            <div class="text-lg font-semibold">Hand Replay</div>
            <div class="chip">{{ hand_id }}</div>
            <div class="w-px h-8 bg-[rgb(var(--border))]"></div>
            <div class="text-sm"><div class="stat-label">Blinds</div><div class="stat-value" id="hud-blinds">—</div></div>
            <div class="w-px h-8 bg-[rgb(var(--border))]"></div>
            <div class="text-sm"><div class="stat-label">Pot</div><div class="stat-value" id="hud-pot">0</div></div>
          </div>

          {% include "ui/_theme_toggle.html" %}
        </div>
      </header>

      <main class="space-y-4" aria-label="Replay Table">
        <section class="card p-4 relative aspect-[16/10] overflow-hidden shadow-elevated" id="table-card">
          <div class="absolute inset-0 grid place-items-center pointer-events-none">
            <div class="flex flex-col items-center">
              <div id="board" class="flex items-center gap-2">
              <div class="card w-12 h-16 grid place-items-center text-xs text-[rgb(var(--muted))]">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[rgb(var(--muted))]">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                  <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                  <path d="M3 12h6" />
                  <path d="M15 12h6" />
                </svg>
              </div>
              <div class="card w-12 h-16 grid place-items-center text-xs text-[rgb(var(--muted))]">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[rgb(var(--muted))]">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                  <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                  <path d="M3 12h6" />
                  <path d="M15 12h6" />
                </svg>
              </div>
              <div class="card w-12 h-16 grid place-items-center text-xs text-[rgb(var(--muted))]">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[rgb(var(--muted))]">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                  <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                  <path d="M3 12h6" />
                  <path d="M15 12h6" />
                </svg>
              </div>
              <div class="card w-12 h-16 grid place-items-center text-xs text-[rgb(var(--muted))]">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[rgb(var(--muted))]">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                  <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                  <path d="M3 12h6" />
                  <path d="M15 12h6" />
                </svg>
              </div>
              <div class="card w-12 h-16 grid place-items-center text-xs text-[rgb(var(--muted))]">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[rgb(var(--muted))]">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                  <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                  <path d="M3 12h6" />
                  <path d="M15 12h6" />
                </svg>
              </div>
              </div>
              <div class="mt-3 chip" id="chip-pot">Pot 0</div>
            </div>
          </div>

          <div class="absolute inset-x-4 top-4 flex items-center justify-center">
            <div class="inline-flex items-center gap-2 card px-3 py-2">
              <div class="w-7 h-7 rounded-full bg-[rgb(var(--border))] flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[rgb(var(--muted))]">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M5 16m0 1.5a1.5 1.5 0 0 1 1.5 -1.5h11a1.5 1.5 0 0 1 1.5 1.5v0a1.5 1.5 0 0 1 -1.5 1.5h-11a1.5 1.5 0 0 1 -1.5 -1.5z" />
                  <path d="M12 16q -2.5 -8 -6 -8q -2.5 0 -3 2c2.953 .31 3.308 3.33 4 6" />
                  <path d="M12 16q 2.5 -8 6 -8q 2.5 0 3 2c-2.953 .31 -3.308 3.33 -4 6" />
                  <path d="M9 9.5q 2 -3.5 3 -3.5t 3 3.5" />
                </svg>
              </div>
              <div>
                <div class="text-sm font-medium">Opponent</div>
                <div class="text-xs text-[rgb(var(--muted))]">Stack <span id="opp-stack">—</span></div>
              </div>
              <div class="flex items-center gap-2">
                <div id="opp-1" class="card w-12 h-16 grid place-items-center text-sm">?</div>
                <div id="opp-2" class="card w-12 h-16 grid place-items-center text-sm">?</div>
              </div>
              <span class="chip" id="dealer-opp" hidden>D</span>
            </div>
          </div>

          <div class="absolute inset-x-4 bottom-4 flex items-center justify-center">
            <div class="inline-flex items-center gap-3 card px-3 py-2">
              <div class="w-7 h-7 rounded-full bg-[rgb(var(--border))] flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-[rgb(var(--muted))]">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M17.108 22.085c-1.266 -.068 -2.924 -.859 -5.071 -2.355l-.04 -.027l-.037 .027c-2.147 1.497 -3.804 2.288 -5.072 2.356l-.178 .005c-2.747 0 -3.097 -2.64 -1.718 -7.244l.054 -.178l-.1 -.075c-6.056 -4.638 -5.046 -7.848 2.554 -8.066l.202 -.005l.115 -.326c1.184 -3.33 2.426 -5.085 4.027 -5.192l.156 -.005c1.674 0 2.957 1.76 4.182 5.197l.114 .326l.204 .005c7.6 .218 8.61 3.428 2.553 8.065l-.102 .075l.055 .178c1.35 4.512 1.04 7.137 -1.556 7.24l-.163 .003z" />
                </svg>
              </div>
              <div>
                <div class="text-sm font-semibold">You</div>
                <div class="text-xs text-[rgb(var(--muted))]">Stack <span id="you-stack">—</span></div>
              </div>
              <div class="flex items-center gap-2">
                <div id="you-1" class="card w-12 h-16 grid place-items-center text-sm">?</div>
                <div id="you-2" class="card w-12 h-16 grid place-items-center text-sm">?</div>
              </div>
              <span class="chip" id="dealer-you" hidden>D</span>
            </div>
          </div>

          <div class="absolute right-3 bottom-3 w-56 flex flex-col gap-2 items-stretch">
            <div id="outcome-wrap" class="card p-3 text-sm" hidden>
              <div class="text-sm font-semibold text-center">Result</div>
              <div class="mt-1 text-sm text-center" id="outcome-text">—</div>
            </div>
            <div class="card p-3 text-sm action-log-card">
              <div class="stat-label">Action Log</div>
              <div id="action-log" class="mt-1 space-y-1 max-h-28 overflow-auto pr-1"></div>
            </div>
          </div>
        </section>
      </main>

      <footer class="sticky bottom-0 z-40 -mx-4 lg:-mx-6 px-4 lg:px-6 py-3 bg-[rgb(var(--surface))]/95 backdrop-blur border-t border-[rgb(var(--border))]">
        <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <button id="btn-restart" class="btn btn-ghost" accesskey="b">Reset</button>
            <button id="btn-prev" class="btn btn-ghost" accesskey="j">◀ Prev</button>
            <button id="btn-next" class="btn btn-ghost" accesskey="l">▶ Next</button>
            <button id="btn-play" class="btn btn-ghost" accesskey="k">▷ Play</button>
          </div>
          <div class="flex items-center gap-2">
            <div class="chip" id="street-chip">Preflop</div>
            <div class="chip" id="step-chip">1 / 0</div>
          </div>
        </div>
      </footer>
    </div>

    <script>
      // 安全的 JSON 解析，防止数据未定义时的错误
      try {
        window.__REPLAY__ = JSON.parse('{{ replay_json|safe|escapejs }}');
      } catch (e) {
        console.error('Failed to parse replay data:', e);
        window.__REPLAY__ = {};
      }

      (function(){
        const R = window.__REPLAY__ || {};
        const $ = s=>document.querySelector(s);
        const $$ = s=>Array.from(document.querySelectorAll(s));

        // 盲注信息 - 使用默认值，因为后端数据中可能没有
        $('#hud-blinds').textContent = 'SB 1 / BB 2';

        const potHud = $('#hud-pot'); const potChip = $('#chip-pot');

        // 从 players 数据中提取手牌信息
        const players = R.players || [];
        const you = players[0]?.hole || [];
        const opp = players[1]?.hole || [];

        function setCardText(element, card) {
          if (!card) return;
          element.textContent = card;
          // 根据花色设置颜色
          const suit = card[1];
          if (suit === '♥' || suit === '♦') {
            element.classList.add('card-red');
            element.classList.remove('card-black');
          } else {
            element.classList.add('card-black');
            element.classList.remove('card-red');
          }
        }

        if(you[0]) setCardText($('#you-1'), you[0]);
        if(you[1]) setCardText($('#you-2'), you[1]);
        if(opp[0]) setCardText($('#opp-1'), opp[0]);
        if(opp[1]) setCardText($('#opp-2'), opp[1]);

        // 显示玩家堆叠
        try{ $('#you-stack').textContent = (players[0]?.stack ?? '—'); }catch(e){}
        try{ $('#opp-stack').textContent = (players[1]?.stack ?? '—'); }catch(e){}
        const boardSlots = $$('#board div');
        function setBoard(k, cid){
          if(boardSlots[k]) {
            const element = boardSlots[k];
            if (cid && cid !== '?') {
              // 显示实际牌面
              element.textContent = cid;
              // 根据花色设置颜色
              const suit = cid[1];
              if (suit === '♥' || suit === '♦') {
                element.classList.add('card-red');
                element.classList.remove('card-black');
              } else {
                element.classList.add('card-black');
                element.classList.remove('card-red');
              }
            } else {
              // 显示牌背面图标
              element.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[rgb(var(--muted))]">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                <path d="M3 12h6" />
                <path d="M15 12h6" />
              </svg>`;
              element.classList.remove('card-red', 'card-black');
            }
          }
        }
        function showOutcome(){
          const out = $('#outcome-wrap');
          if(R.winner==null){ out.hidden=true; return;}
          const who=(R.winner===0?'You':'Opponent');
          const best = Array.isArray(R.best5) && R.best5[R.winner] ? ('Best5: ' + R.best5[R.winner].join(' ')) : '';
          $('#outcome-text').innerHTML = `${who} wins${best ? '<br>' + best : ''}`;
          out.hidden=false;
        }

        // 从 events 数据构建 timeline
        const events = R.events || [];
        const A = events
          .filter(event => {
            // 引擎发牌事件：t:'board', street in ['flop','turn','river']
            if (event.t === 'board' && ['flop','turn','river'].includes(event.street)) return true;
            // 行动类事件
            return ['blind', 'check', 'call', 'bet', 'raise', 'fold', 'allin'].includes(event.t);
          })
          .map(event => {
            if (event.t === 'board') {
              const move = event.street === 'flop' ? 'deal_flop' : (event.street === 'turn' ? 'deal_turn' : 'deal_river');
              return { street: event.street[0].toUpperCase() + event.street.slice(1), actor: 'system', move, amt: null };
            }
            return { street: null, actor: (event.who === 0 ? 'you' : 'opponent'), move: event.t, amt: event.amt };
          });
        const logBox = $('#action-log');
        const streetChip=$('#street-chip');
        const stepChip=$('#step-chip');
        let i=-1,total=A.length,pot=0,playing=false,timer=null;
        stepChip.textContent = `${Math.max(i+1,1)} / ${total}`;

        function lineText(a){
          if (!a) return '—';
          const who=a.actor==='you'?'You':(a.actor==='opponent'?'Opponent':'System');
          return `${who} ${a.move}${(a.amt!=null?(' '+a.amt):'')}`;
        }
        function renderLog(){ logBox.innerHTML=''; A.forEach((a,idx)=>{ const row=document.createElement('div'); row.className='flex justify-between'; row.dataset.idx=idx; row.innerHTML = `<span class=\"text-[rgb(var(--muted))]\">${a.street||'—'}</span><span>${lineText(a)}</span>`; logBox.appendChild(row); }); }
        renderLog();
        function setStep(){ stepChip.textContent = `${Math.max(i+1,1)} / ${total}`; }
        function setPot(){ potHud.textContent = pot; potChip.textContent = `Pot ${pot}`; }
        function setStreet(s){ streetChip.textContent = s||'—'; }
        function highlight(){ logBox.querySelectorAll('[data-idx]').forEach(el=>el.classList.remove('row-current')); if(i>=0){ const row = logBox.querySelector(`[data-idx=\"${i}\"]`); row&&row.classList.add('row-current'); row&&row.scrollIntoView({block:'nearest'});} }
        function apply(a){
          if(!a) return;
          if (a.street) setStreet(a.street);
          if(typeof a.amt==='number') pot += a.amt;
          if(a.move==='deal_flop' && R.board && R.board.length >= 3){
            setBoard(0, R.board[0]); setBoard(1, R.board[1]); setBoard(2, R.board[2]);
          }
          if(a.move==='deal_turn' && R.board && R.board.length >= 4){
            setBoard(3, R.board[3]);
          }
          if(a.move==='deal_river' && R.board && R.board.length >= 5){
            setBoard(4, R.board[4]);
          }
          setPot();
        }
        function rollback(a){
          if(!a) return;
          if(typeof a.amt==='number') pot -= a.amt;
          if(a.move==='deal_flop'){ setBoard(0,'?'); setBoard(1,'?'); setBoard(2,'?'); }
          if(a.move==='deal_turn'){ setBoard(3,'?'); }
          if(a.move==='deal_river'){ setBoard(4,'?'); }
          setPot();
        }
        function next(){ if(i+1>=total) return; i++; apply(A[i]); setStep(); highlight(); }
        function prev(){ if(i<0) return; rollback(A[i]); i--; setStep(); highlight(); }
        function restart(){ while(i>=0){ rollback(A[i]); i--; } pot=0; setStep(); highlight(); setStreet('Preflop'); }
        function setDisabled(d){ ['#btn-restart','#btn-prev','#btn-next'].forEach(sel=>{ const b=$(sel); if(b) b.disabled=d; }); }
        function play(){ if(playing) return; playing=true; setDisabled(true); const btn=$('#btn-play'); if(btn) btn.textContent='❚❚ Pause'; timer=setInterval(()=>{ if(i+1>=total){ stop(); return;} next(); }, 650); }
        function stop(){ playing=false; setDisabled(false); const btn=$('#btn-play'); if(btn) btn.textContent='▷ Play'; if(timer){clearInterval(timer); timer=null;} }
        // 绑定按钮事件监听器
        const btnNext = $('#btn-next');
        const btnPrev = $('#btn-prev');
        const btnRestart = $('#btn-restart');
        const btnPlay = $('#btn-play');

        if (btnNext) btnNext.addEventListener('click', next);
        if (btnPrev) btnPrev.addEventListener('click', prev);
        if (btnRestart) btnRestart.addEventListener('click', restart);
        if (btnPlay) btnPlay.addEventListener('click', ()=> playing?stop():play());

        // 键盘事件监听器
        addEventListener('keydown',(e)=>{
          if(['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
          const k=e.key.toLowerCase();
          if(k==='l') next();
          else if(k==='j') prev();
          else if(k==='b') restart();
          else if(k==='k') (playing?stop():play());
        });

        // 初始化状态
        setPot(); setStep(); setStreet('Preflop'); showOutcome();

        // 调试信息
        console.log('Replay initialized:', { total, R });

      })();
    </script>

    <!-- Theme toggle JavaScript -->
    <script src="/static/js/theme-toggle.js"></script>
  </body>
</html>

